{% extends 'base.html' %}

{% block content %}
<style>
    .nav-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.3);
        color: rgba(255, 255, 255, 0.5);
        padding: 15px 10px;
        border-radius: 5px;
        text-decoration: none;
        transition: all 0.2s;
        z-index: 100;
        /* Above face boxes */
        cursor: pointer;
        border: none;
    }

    .nav-button:hover {
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
    }

    .nav-left {
        left: 10px;
    }

    .nav-right {
        right: 10px;
    }
</style>
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-truncate mx-3" style="max-width: 50%;">{{ asset.title or asset.file_path|basename
                    }}</h5>
                <div>
                    <button class="btn btn-outline-warning btn-sm me-2" id="btnAddFaceToggle"
                        onclick="toggleAddFaceMode()">
                        <i class="bi bi-bounding-box-circles"></i> Add Missing Face
                    </button>
                    <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm">{{ back_label }}</a>
                </div>
            </div>
            <div class="card-body text-center bg-dark" style="position: relative;">
                {% if prev_id %}
                <!-- Swapped: PREV button goes to NEXT_ID (Left arrow -> Older/Forward in ID) -->
                <a href="{{ url_for('main.asset_detail', asset_id=next_id, sort=current_sort, path_filter=current_filter, view_mode=view_mode, folder_path=folder_path) if next_id else '#' }}"
                    class="nav-button nav-left {{ 'disabled' if not next_id }}" id="btnPrev"
                    title="Next Image (Right in Grid)">
                    <i class="bi bi-caret-left-fill display-5"></i>
                </a>
                {% endif %}

                {% if next_id %}
                <!-- Swapped: NEXT button goes to PREV_ID (Right arrow -> Newer/Back in ID) -->
                <a href="{{ url_for('main.asset_detail', asset_id=prev_id, sort=current_sort, path_filter=current_filter, view_mode=view_mode, folder_path=folder_path) if prev_id else '#' }}"
                    class="nav-button nav-right {{ 'disabled' if not prev_id }}" id="btnNext"
                    title="Previous Image (Left in Grid)">
                    <i class="bi bi-caret-right-fill display-5"></i>
                </a>
                {% endif %}

                {% if asset.media_type in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                <div style="position: relative; display: inline-block; cursor: default;" id="imageContainer">
                    <img id="mainImage" src="{{ url_for('main.serve_image', asset_id=asset.id) }}" class="img-fluid"
                        style="max-height: 600px; -webkit-user-drag: none; user-select: none;">

                    <!-- Face Boxes Overlay -->
                    <div id="faceOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    </div>

                    <!-- Drawing Overlay -->
                    <div id="drawingOverlay"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: none; cursor: crosshair;">
                    </div>
                </div>
                {% else %}
                <div class="py-5 text-white">
                    <h1>{{ asset.media_type|upper }}</h1>
                    <p>Preview not available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <!-- Metadata Column -->
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#metadata-tab"
                            type="button">Current</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history-tab" type="button"
                            onclick="loadHistory()">History (Backups)</button>
                    </li>
                </ul>
            </div>
            <div class="card-body tab-content">
                <!-- Metadata Tab -->
                <div class="tab-pane fade show active" id="metadata-tab" role="tabpanel">
                    <dl class="row">
                        <!-- Face List -->
                        {% if asset.faces.count() > 0 %}
                        <dt class="col-sm-12">People</dt>
                        <dd class="col-sm-12">
                            {% for face in asset.faces %}
                            <a href="{{ url_for('main.person_detail', person_id=face.person.id) if face.person else '#' }}"
                                class="badge {{ 'bg-success' if face.is_confirmed else 'bg-warning text-dark' }} text-decoration-none me-1">
                                {{ face.person.name if face.person else 'Unknown' }}
                            </a>
                            {% endfor %}
                        </dd>
                        {% endif %}

                        <dt class="col-sm-4">Captured</dt>
                        <dd class="col-sm-8">{{ asset.captured_at or 'Unknown' }}</dd>

                        <dt class="col-sm-4">Added</dt>
                        <dd class="col-sm-8">{{ asset.added_at }}</dd>

                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8">{{ asset.media_type }}</dd>
                    </dl>

                    {% if asset.meta_json %}
                    {% if asset.meta_json.get('Description') or asset.meta_json.get('Caption-Abstract') %}
                    <div class="alert alert-info mt-3">
                        <strong>Description:</strong>
                        {{ asset.meta_json.get('Description') or asset.meta_json.get('Caption-Abstract') }}
                    </div>
                    {% endif %}
                    {% endif %}

                    {% set raw_rating = asset.meta_json.get('Rating') or asset.meta_json.get('rating') or
                    asset.meta_json.get('XMP:Rating') or 0 %}
                    {% set rating = raw_rating|int %}
                    {% if rating > 0 %}
                    <div class="mt-2 mb-3">
                        <strong>Rating:</strong>
                        <span class="text-warning" style="font-size: 1.2rem;">
                            {% for i in range(1, 6) %}
                            <i class="bi {{ 'bi-star-fill' if i <= rating else 'bi-star' }}"></i>
                            {% endfor %}
                        </span>
                        <span class="text-muted small">({{ rating }})</span>
                    </div>
                    {% endif %}



                    <!-- Info Buttons -->
                    {% if ai_info %}
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal"
                            data-bs-target="#aiInfoModal">
                            ‚ú® View AI Generation Details
                        </button>
                    </div>
                    {% endif %}

                    {% if camera_info %}
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal"
                            data-bs-target="#cameraInfoModal">
                            üì∑ View Camera Details
                        </button>
                    </div>
                    {% endif %}

                    {% if gps_info %}
                    <div class="mt-3">
                        <a href="https://www.google.com/maps/search/?api=1&query={{ gps_info.lat }},{{ gps_info.lng }}"
                            target="_blank" class="btn btn-outline-success w-100">
                            üìç View on Google Maps
                        </a>
                    </div>
                    {% endif %}

                    <hr>
                    <h6>Raw Metadata (JSON)</h6>
                    <div
                        style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                        <pre class="small mb-0"><code>{{ asset.meta_json | tojson(indent=2) }}</code></pre>
                    </div>
                </div>
            </div> <!-- End Function of Metadata Tab -->

            <!-- History Tab -->
            <div class="tab-pane fade" id="history-tab" role="tabpanel">
                <div id="historyLoading" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="small text-muted mt-2">Finding backups...</p>
                </div>
                <div id="historyContent" style="display: none;">
                    <table class="table table-sm table-hover small">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
                <div id="historyEmpty" class="text-center text-muted py-3" style="display: none;">
                    <i class="bi bi-clock-history display-6"></i>
                    <p>No backups found.</p>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Actions</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.open_folder', asset_id=asset.id) }}">
                    <button type="submit" class="btn btn-outline-info w-100 mb-2">
                        <i class="bi bi-folder-symlink"></i> Show in Folder
                    </button>
                </form>
                <a href="{{ url_for('main.refresh_metadata', asset_id=asset.id) }}" class="btn btn-warning w-100 mb-2">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Metadata
                </a>
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#editMetadataModal">
                    <i class="bi bi-pencil-square"></i> Edit Metadata
                </button>
            </div>
        </div>
    </div>
</div>

<!-- HIDDEN FORMS -->
<form id="deleteFaceForm" method="POST" style="display: none;"></form>

<!-- Add Face Confirm Modal -->
<div class="modal fade" id="addFaceConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('main.add_manual_face', asset_id=asset.id) }}" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm New Face</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Add a new face region here?</p>
                    <input type="hidden" name="top" id="newFaceTop">
                    <input type="hidden" name="right" id="newFaceRight">
                    <input type="hidden" name="bottom" id="newFaceBottom">
                    <input type="hidden" name="left" id="newFaceLeft">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Face</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if ai_info %}
<!-- AI Info Modal -->
<div class="modal fade" id="aiInfoModal" tabindex="-1" aria-labelledby="aiInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiInfoModalLabel">‚ú® AI Generation Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Model Version</label>
                    <p>{{ ai_info.get('Model', 'Unknown') }}</p>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold">Style Name</label>
                        <p>{{ ai_info.get('StyleName', 'N/A') }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold">Base Style</label>
                        <p>{{ ai_info.get('BaseStyle', 'N/A') }}</p>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fw-bold">Prompt</label>
                    <div class="p-3 bg-light rounded border">
                        {{ ai_info.get('Prompt', 'No prompt data available.') }}
                    </div>
                </div>

                {% if ai_info.get('Parameters') %}
                <div class="mb-3">
                    <label class="fw-bold">Parameters</label>
                    <table class="table table-sm table-bordered mt-1">
                        <thead class="table-light">
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in ai_info.get('Parameters').items() %}
                            <tr>
                                <td>{{ key }}</td>
                                <td>
                                    {% if value is sameas true %}
                                    <span class="badge bg-success">Yes</span>
                                    {% elif value is sameas false %}
                                    <span class="badge bg-secondary">No</span>
                                    {% elif value is none %}
                                    <span class="text-muted">None</span>
                                    {% else %}
                                    {{ value }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <div class="text-end text-muted small">
                    Generated by {{ ai_info.get('Software', 'Unknown Software') }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if camera_info %}
<!-- Camera Info Modal -->
<div class="modal fade" id="cameraInfoModal" tabindex="-1" aria-labelledby="cameraInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraInfoModalLabel">üì∑ Camera Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if camera_info.get('Make') or camera_info.get('Model') %}
                <div class="mb-3">
                    <label class="fw-bold">Camera</label>
                    <p class="fs-5">{{ camera_info.get('Make', '') }} {{ camera_info.get('Model', '') }}</p>
                </div>
                {% endif %}

                {% if camera_info.get('Lens') %}
                <div class="mb-3">
                    <label class="fw-bold">Lens</label>
                    <p>{{ camera_info.get('Lens') }}</p>
                </div>
                {% endif %}

                <div class="row">
                    {% if camera_info.get('ISO') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">ISO</label>
                        <div>{{ camera_info.get('ISO') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('Aperture') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Aperture</label>
                        <div>∆í/{{ camera_info.get('Aperture') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('ShutterSpeed') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Shutter</label>
                        <div>{{ camera_info.get('ShutterSpeed') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('FocalLength') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Focal Length</label>
                        <div>{{ camera_info.get('FocalLength') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('Flash') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Flash</label>
                        <div>{{ camera_info.get('Flash') }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Assign Face Modal -->
<div class="modal fade" id="assignFaceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('main.assign_face_form') }}" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Name this person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="face_id" id="modalFaceId">

                    <div class="mb-3">
                        <label class="form-label">Select Existing Person</label>
                        <select name="person_id" class="form-select">
                            <option value="">-- Select Person --</option>
                            {% for p in people %}
                            <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="text-center my-2 text-muted">- OR -</div>

                    <div class="mb-3">
                        <label class="form-label">Create New Person</label>
                        <input type="text" name="new_person_name" class="form-control" placeholder="e.g. Uncle Bob">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div>
                        <button type="submit" name="action" value="remove" class="btn btn-outline-warning"
                            onclick="return confirm('Are you sure you want to unassign this person?');">
                            <i class="bi bi-person-x"></i> Unassign
                        </button>
                        <button type="button" class="btn btn-outline-danger ms-1" onclick="deleteFace()">
                            <i class="bi bi-trash"></i> Not a Face
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="action" value="save" class="btn btn-primary">Save
                            Assignment</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Metadata Modal -->
<div class="modal fade" id="editMetadataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('main.update_metadata', asset_id=asset.id) }}" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Metadata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Title</label>
                        <input type="text" name="title" class="form-control"
                            value="{{ asset.title or asset.meta_json.get('title') or '' }}">
                    </div>

                    <!-- Description / Caption -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description / Caption</label>
                        <textarea name="description" class="form-control" rows="4">{{ 
                            asset.meta_json.get('description') or 
                            asset.meta_json.get('Description') or 
                            asset.meta_json.get('Caption-Abstract') or '' 
                        }}</textarea>
                    </div>

                    <!-- Rating (Interactive) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Rating</label>
                        {% set current_rating = asset.meta_json.get('rating')|int if asset.meta_json.get('rating') else
                        0 %}
                        <input type="hidden" name="rating" id="ratingInput" value="{{ current_rating }}">

                        <div class="user-select-none" style="font-size: 1.5rem; cursor: pointer;">
                            <i class="bi bi-star" id="star1" onclick="setRating(1)"></i>
                            <i class="bi bi-star" id="star2" onclick="setRating(2)"></i>
                            <i class="bi bi-star" id="star3" onclick="setRating(3)"></i>
                            <i class="bi bi-star" id="star4" onclick="setRating(4)"></i>
                            <i class="bi bi-star" id="star5" onclick="setRating(5)"></i>
                            <span class="ms-2 text-muted small" id="ratingLabel" style="font-size: 0.9rem;">
                                {% if current_rating > 0 %}{{ current_rating }} Star{% if current_rating > 1 %}s{% endif
                                %}{% else %}No Rating{% endif %}
                            </span>
                        </div>
                    </div>

                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> Saving will update the database AND write directly to the file
                        (safely).
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    console.log("Asset Detail Script Logic Loaded");


    // --- Star Rating Logic ---
    function setRating(val) {
        const input = document.getElementById('ratingInput');
        let current = parseInt(input.value || 0);

        // Toggle off if clicking same value
        if (current === val) {
            current = 0;
        } else {
            current = val;
        }

        input.value = current;
        updateStarVisuals(current);
    }

    function updateStarVisuals(val) {
        const label = document.getElementById('ratingLabel');
        if (val === 0) {
            label.textContent = "No Rating";
        } else {
            label.textContent = val + " Star" + (val > 1 ? "s" : "");
        }

        for (let i = 1; i <= 5; i++) {
            const star = document.getElementById('star' + i);
            if (i <= val) {
                star.classList.replace('bi-star', 'bi-star-fill');
                star.classList.add('text-warning');
            } else {
                star.classList.replace('bi-star-fill', 'bi-star');
                star.classList.remove('text-warning');
            }
        }
    }

    // Init Stars on Load
    document.addEventListener('DOMContentLoaded', function () {
        // ... existing load ...
        const initialRating = parseInt(document.getElementById('ratingInput').value || 0);
        updateStarVisuals(initialRating);
    });

    // --- Global Variables & Functions (Must be accessible to HTML onlick) ---
    let isAddMode = false;
    let isDrawing = false;
    let startX, startY;
    let selectionBox = null;

    function toggleAddFaceMode() {
        isAddMode = !isAddMode;
        const btn = document.getElementById('btnAddFaceToggle');
        const overlay = document.getElementById('drawingOverlay');

        if (isAddMode) {
            btn.classList.replace('btn-outline-warning', 'btn-warning');
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel Add';
            overlay.style.display = 'block';
            // Disable overlays to prevent navigation clicks
            document.querySelectorAll('.nav-overlay').forEach(el => el.style.pointerEvents = 'none');
        } else {
            btn.classList.replace('btn-warning', 'btn-outline-warning');
            btn.innerHTML = '<i class="bi bi-bounding-box-circles"></i> Add Missing Face';
            overlay.style.display = 'none';
            if (selectionBox) selectionBox.remove();
            selectionBox = null;
            document.querySelectorAll('.nav-overlay').forEach(el => el.style.pointerEvents = 'auto');
        }
    }

    function deleteFace() {
        if (!confirm('Are you sure this is NOT a face? It will be permanently deleted.')) return;

        const faceId = document.getElementById('modalFaceId').value;
        const form = document.getElementById('deleteFaceForm');
        form.action = `/face/${faceId}/delete`;
        form.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM Content Loaded");
        const img = document.getElementById('mainImage');
        const drawingOverlay = document.getElementById('drawingOverlay');

        if (!img) {
            console.error("Main image not found!");
            return;
        }

        // Safe variable assignment
        const faces = {{ faces_data | tojson
    }};
    console.log('Face Data:', faces);

    function openAssignModal(faceId) {
        document.getElementById('modalFaceId').value = faceId;
        const modal = new bootstrap.Modal(document.getElementById('assignFaceModal'));

        // --- Smart Sort Logic ---
        const select = document.querySelector('#assignFaceModal select[name="person_id"]');
        select.innerHTML = '<option>Loading matches...</option>';
        modal.show();

        fetch(`/face/${faceId}/matches`)
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="">-- Select Person --</option>';

                let hasSuggestions = false;
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    if (p.is_suggested) {
                        hasSuggestions = true;
                        opt.text = `‚≠ê ${p.name} (${p.score}% Match)`;
                        opt.style.fontWeight = 'bold';
                        opt.style.color = '#198754';
                    } else {
                        opt.text = p.name;
                    }
                    select.appendChild(opt);
                });

                if (hasSuggestions) select.scrollTop = 0;
            })
            .catch(err => {
                console.error("Error loading matches", err);
                select.innerHTML = '<option value="">Error loading people</option>';
            });
    }

    function drawBoxes() {
        const overlay = document.getElementById('faceOverlay');
        overlay.innerHTML = ''; // Clear existing

        const naturalW = img.naturalWidth;
        const naturalH = img.naturalHeight;
        const displayW = img.clientWidth;
        const displayH = img.clientHeight;

        if (naturalW === 0 || displayW === 0) return;

        const scaleX = displayW / naturalW;
        const scaleY = displayH / naturalH;

        faces.forEach(face => {
            if (face.top === 0 && face.right === 0) return; // Skip invalid

            const boxTop = face.top * scaleY;
            const boxLeft = face.left * scaleX;
            const boxWidth = (face.right - face.left) * scaleX;
            const boxHeight = (face.bottom - face.top) * scaleY;

            const borderClass = face.is_confirmed ? 'border-success' : 'border-warning';

            const box = document.createElement('div');
            box.className = `position-absolute border ${borderClass}`;
            box.style.borderWidth = '2px';
            box.style.top = `${boxTop}px`;
            box.style.left = `${boxLeft}px`;
            box.style.width = `${boxWidth}px`;
            box.style.height = `${boxHeight}px`;
            box.style.cursor = 'pointer';
            box.style.pointerEvents = 'auto'; // CRITICAL: Re-enable clicks
            box.title = "Click to assign name";

            // Click to open modal
            box.onclick = function () {
                openAssignModal(face.id);
            };

            // Label
            const label = document.createElement('span');
            label.className = `position-absolute badge ${face.is_confirmed ? 'bg-success' : 'bg-warning text-dark'}`;
            label.style.bottom = '100%';
            label.style.left = '0';
            label.textContent = face.name;
            box.appendChild(label);

            overlay.appendChild(box);
        });
    }

    // Draw boxes when image loads or window resizes
    if (img.complete) {
        drawBoxes();
    } else {
        img.onload = drawBoxes;
    }
    window.addEventListener('resize', drawBoxes);

    // Keyboard Navigation
    document.addEventListener('keydown', function (event) {
        // Ignore if focus is in an input
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.isContentEditable) {
            return;
        }

        if (event.key === 'ArrowLeft') {
            const btn = document.getElementById('btnPrev');
            if (btn && !btn.disabled) btn.click();
        } else if (event.key === 'ArrowRight') {
            const btn = document.getElementById('btnNext');
            if (btn && !btn.disabled) btn.click();
        }
    });

    // --- Drawing Logic Listeners ---
    drawingOverlay.addEventListener('mousedown', function (e) {
        isDrawing = true;
        const rect = drawingOverlay.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;

        if (selectionBox) selectionBox.remove();
        selectionBox = document.createElement('div');
        selectionBox.style.border = '2px dashed #0d6efd';
        selectionBox.style.backgroundColor = 'rgba(13, 110, 253, 0.2)';
        selectionBox.style.position = 'absolute';
        selectionBox.style.left = startX + 'px';
        selectionBox.style.top = startY + 'px';
        drawingOverlay.appendChild(selectionBox);
    });

    drawingOverlay.addEventListener('mousemove', function (e) {
        if (!isDrawing) return;
        const rect = drawingOverlay.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;

        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        const left = Math.min(currentX, startX);
        const top = Math.min(currentY, startY);

        selectionBox.style.width = width + 'px';
        selectionBox.style.height = height + 'px';
        selectionBox.style.left = left + 'px';
        selectionBox.style.top = top + 'px';
    });

    drawingOverlay.addEventListener('mouseup', function (e) {
        if (!isDrawing) return;
        isDrawing = false;

        // Calculate coords relative to natural image size
        const rect = drawingOverlay.getBoundingClientRect();
        const finalW = parseInt(selectionBox.style.width);
        const finalH = parseInt(selectionBox.style.height);

        if (finalW < 10 || finalH < 10) {
            selectionBox.remove(); // Too small
            return;
        }

        const displayW = img.clientWidth;
        const displayH = img.clientHeight;
        const naturalW = img.naturalWidth;
        const naturalH = img.naturalHeight;

        const scaleX = naturalW / displayW;
        const scaleY = naturalH / displayH;

        const boxLeft = parseInt(selectionBox.style.left);
        const boxTop = parseInt(selectionBox.style.top);

        // Coords: top, right, bottom, left
        const paramTop = Math.round(boxTop * scaleY);
        const paramLeft = Math.round(boxLeft * scaleX);
        const paramBottom = Math.round((boxTop + finalH) * scaleY);
        const paramRight = Math.round((boxLeft + finalW) * scaleX);

        document.getElementById('newFaceTop').value = paramTop;
        document.getElementById('newFaceRight').value = paramRight;
        document.getElementById('newFaceBottom').value = paramBottom;
        document.getElementById('newFaceLeft').value = paramLeft;

        // Open Confirm Modal
        // Use 'bootstrap' from the global namespace if not locally bound, 
        // or just rely on the script tag loading it into window.bootstrap
        const myModalEl = document.getElementById('addFaceConfirmModal');
        if (myModalEl) {
            const modal = new bootstrap.Modal(myModalEl);
            modal.show();
        } else {
            console.error("Confirm modal element not found!");
        }
    });
    });
    // --- History Logic ---
    let historyLoaded = false;
    function loadHistory() {
        if (historyLoaded) return;

        fetch(`/asset/{{ asset.id }}/history`)
            .then(r => r.json())
            .then(data => {
                const backups = data.backups;
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';

                document.getElementById('historyLoading').style.display = 'none';

                if (backups.length === 0) {
                    document.getElementById('historyEmpty').style.display = 'block';
                    return;
                }

                document.getElementById('historyContent').style.display = 'block';

                backups.forEach(b => {
                    const row = document.createElement('tr');

                    // Date Column
                    const dateCol = document.createElement('td');
                    dateCol.textContent = b.pretty_time;
                    row.appendChild(dateCol);

                    // Action Column
                    const actionCol = document.createElement('td');

                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-danger';
                    btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Restore';
                    btn.title = "Restore this version";
                    btn.onclick = () => confirmRestore(b.path, b.pretty_time);

                    actionCol.appendChild(btn);
                    row.appendChild(actionCol);

                    tbody.appendChild(row);
                });

                historyLoaded = true; // prevent re-fetch
            })
            .catch(err => {
                console.error(err);
                document.getElementById('historyLoading').innerHTML = '<p class="text-danger">Error loading history.</p>';
            });
    }

    function confirmRestore(path, time) {
        if (!confirm(`Are you sure you want to restore metadata from ${time}?\n\nThis will overwrite current tags. A new backup will be created safely.`)) return;

        // Post form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/asset/{{ asset.id }}/restore`;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'backup_path';
        input.value = path;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}