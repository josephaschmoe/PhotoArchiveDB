{% extends 'base.html' %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ asset.title or asset.file_path }}</h5>
                <a href="/" class="btn btn-outline-secondary btn-sm">Back to Library</a>
            </div>
            <div class="card-body text-center bg-dark">
                {% if asset.media_type in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                <img src="{{ url_for('main.serve_image', asset_id=asset.id) }}" class="img-fluid"
                    style="max-height: 600px;">
                {% else %}
                <div class="py-5 text-white">
                    <h1>{{ asset.media_type|upper }}</h1>
                    <p>Preview not available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                Metadata
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Captured</dt>
                    <dd class="col-sm-8">{{ asset.captured_at or 'Unknown' }}</dd>

                    <dt class="col-sm-4">Added</dt>
                    <dd class="col-sm-8">{{ asset.added_at }}</dd>

                    <dt class="col-sm-4">Type</dt>
                    <dd class="col-sm-8">{{ asset.media_type }}</dd>
                </dl>

                {% if asset.meta_json %}
                {% if asset.meta_json.get('Description') or asset.meta_json.get('Caption-Abstract') %}
                <div class="alert alert-info mt-3">
                    <strong>Description:</strong>
                    {{ asset.meta_json.get('Description') or asset.meta_json.get('Caption-Abstract') }}
                </div>
                {% endif %}
                {% endif %}

                {% if ai_info %}
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal"
                        data-bs-target="#aiInfoModal">
                        ‚ú® View AI Generation Details
                    </button>
                </div>
                {% endif %}

                {% if camera_info %}
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal"
                        data-bs-target="#cameraInfoModal">
                        üì∑ View Camera Details
                    </button>
                </div>
                {% endif %}

                {% if gps_info %}
                <div class="mt-3">
                    <a href="https://www.google.com/maps/search/?api=1&query={{ gps_info.lat }},{{ gps_info.lng }}"
                        target="_blank" class="btn btn-outline-success w-100">
                        üìç View on Google Maps
                    </a>
                </div>
                {% endif %}

                <hr>
                <h6>Raw Metadata (JSON)</h6>
                <div
                    style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                    <pre class="small mb-0"><code>{{ asset.meta_json | tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Actions</div>
            <div class="card-body">
                <!-- Placeholder for future edit/sync actions -->
                <a href="{{ url_for('main.refresh_metadata', asset_id=asset.id) }}" class="btn btn-warning w-100 mb-2">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Metadata
                </a>
                <button class="btn btn-secondary w-100" disabled>Edit Metadata (Coming Soon)</button>
            </div>
        </div>
    </div>
</div>

{% if ai_info %}
<!-- AI Info Modal -->
<div class="modal fade" id="aiInfoModal" tabindex="-1" aria-labelledby="aiInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiInfoModalLabel">‚ú® AI Generation Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Model Version</label>
                    <p>{{ ai_info.get('Model', 'Unknown') }}</p>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold">Style Name</label>
                        <p>{{ ai_info.get('StyleName', 'N/A') }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold">Base Style</label>
                        <p>{{ ai_info.get('BaseStyle', 'N/A') }}</p>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fw-bold">Prompt</label>
                    <div class="p-3 bg-light rounded border">
                        {{ ai_info.get('Prompt', 'No prompt data available.') }}
                    </div>
                </div>

                {% if ai_info.get('Parameters') %}
                <div class="mb-3">
                    <label class="fw-bold">Parameters</label>
                    <table class="table table-sm table-bordered mt-1">
                        <thead class="table-light">
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in ai_info.get('Parameters').items() %}
                            <tr>
                                <td>{{ key }}</td>
                                <td>
                                    {% if value is sameas true %}
                                    <span class="badge bg-success">Yes</span>
                                    {% elif value is sameas false %}
                                    <span class="badge bg-secondary">No</span>
                                    {% elif value is none %}
                                    <span class="text-muted">None</span>
                                    {% else %}
                                    {{ value }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <div class="text-end text-muted small">
                    Generated by {{ ai_info.get('Software', 'Unknown Software') }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if camera_info %}
<!-- Camera Info Modal -->
<div class="modal fade" id="cameraInfoModal" tabindex="-1" aria-labelledby="cameraInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraInfoModalLabel">üì∑ Camera Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if camera_info.get('Make') or camera_info.get('Model') %}
                <div class="mb-3">
                    <label class="fw-bold">Camera</label>
                    <p class="fs-5">{{ camera_info.get('Make', '') }} {{ camera_info.get('Model', '') }}</p>
                </div>
                {% endif %}

                {% if camera_info.get('Lens') %}
                <div class="mb-3">
                    <label class="fw-bold">Lens</label>
                    <p>{{ camera_info.get('Lens') }}</p>
                </div>
                {% endif %}

                <div class="row">
                    {% if camera_info.get('ISO') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">ISO</label>
                        <div>{{ camera_info.get('ISO') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('Aperture') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Aperture</label>
                        <div>∆í/{{ camera_info.get('Aperture') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('ShutterSpeed') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Shutter</label>
                        <div>{{ camera_info.get('ShutterSpeed') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('FocalLength') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Focal Length</label>
                        <div>{{ camera_info.get('FocalLength') }}</div>
                    </div>
                    {% endif %}

                    {% if camera_info.get('Flash') %}
                    <div class="col-6 mb-2">
                        <label class="fw-bold small text-muted">Flash</label>
                        <div>{{ camera_info.get('Flash') }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}